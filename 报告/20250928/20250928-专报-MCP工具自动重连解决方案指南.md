# MCPå·¥å…·è‡ªåŠ¨é‡è¿è§£å†³æ–¹æ¡ˆæŒ‡å—

## ğŸ“‹ é—®é¢˜åˆ†æ

### ğŸ” MCPå·¥å…·æ‰çº¿å¸¸è§åŸå› 
- **ç½‘ç»œè¶…æ—¶**ï¼šé•¿æ—¶é—´æ— æ´»åŠ¨å¯¼è‡´è¿æ¥è¶…æ—¶
- **è®¤è¯è¿‡æœŸ**ï¼šAPI Tokenæˆ–è®¤è¯ä¿¡æ¯è¿‡æœŸ
- **æœåŠ¡ç«¯é™åˆ¶**ï¼šè¯·æ±‚é¢‘ç‡è¿‡é«˜è¢«é™æµ
- **ç½‘ç»œæ³¢åŠ¨**ï¼šç½‘ç»œä¸ç¨³å®šå¯¼è‡´è¿æ¥ä¸­æ–­
- **å†…å­˜æ³„æ¼**ï¼šé•¿æœŸè¿è¡Œå¯¼è‡´å®¢æˆ·ç«¯å†…å­˜é—®é¢˜

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šCursor IDEé…ç½®ä¼˜åŒ–

#### 1. MCPé…ç½®æ–‡ä»¶ä¼˜åŒ–
åœ¨Cursorçš„è®¾ç½®ä¸­æ‰¾åˆ°MCPé…ç½®æ–‡ä»¶ï¼ˆé€šå¸¸åœ¨ `.cursor/mcp_settings.json`ï¼‰ï¼Œæ·»åŠ é‡è¿å‚æ•°ï¼š

```json
{
  "mcpServers": {
    "yingmi_mcp": {
      "command": "...",
      "args": [...],
      "reconnection": {
        "enabled": true,
        "maxRetries": 5,
        "retryDelay": 2000,
        "exponentialBackoff": true,
        "maxRetryDelay": 30000
      },
      "keepAlive": {
        "enabled": true,
        "interval": 30000,
        "timeout": 10000
      }
    },
    "search_caixin_content": {
      "command": "...",
      "args": [...],
      "reconnection": {
        "enabled": true,
        "maxRetries": 5,
        "retryDelay": 2000,
        "exponentialBackoff": true
      }
    },
    "Tavily_MCP_Server": {
      "command": "...",
      "args": [...],
      "reconnection": {
        "enabled": true,
        "maxRetries": 5,
        "retryDelay": 2000,
        "exponentialBackoff": true
      }
    }
  }
}
```

### æ–¹æ¡ˆäºŒï¼šPowerShellç›‘æ§è„šæœ¬ï¼ˆæ¨èï¼‰

åˆ›å»ºè‡ªåŠ¨ç›‘æ§å’Œé‡è¿è„šæœ¬ï¼š

```powershell
# MCPå·¥å…·ç›‘æ§å’Œè‡ªåŠ¨é‡è¿è„šæœ¬
# ä¿å­˜ä¸º: MCP_AutoReconnect.ps1

param(
    [int]$CheckInterval = 30,  # æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
    [int]$MaxRetries = 3       # æœ€å¤§é‡è¯•æ¬¡æ•°
)

# MCPå·¥å…·è¿›ç¨‹åç§°ï¼ˆéœ€è¦æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰
$MCPProcesses = @(
    "yingmi_mcp",
    "caixin_mcp", 
    "tavily_mcp"
)

# æ—¥å¿—å‡½æ•°
function Write-Log {
    param([string]$Message)
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    Write-Output "[$timestamp] $Message"
    Add-Content -Path "MCP_Monitor.log" -Value "[$timestamp] $Message"
}

# æ£€æŸ¥MCPæœåŠ¡çŠ¶æ€
function Test-MCPService {
    param([string]$ServiceName)
    
    try {
        # è¿™é‡Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´æ£€æŸ¥é€»è¾‘
        # å¯ä»¥é€šè¿‡æ£€æŸ¥è¿›ç¨‹ã€ç«¯å£æˆ–APIå“åº”æ¥åˆ¤æ–­
        $process = Get-Process -Name $ServiceName -ErrorAction SilentlyContinue
        return $process -ne $null
    }
    catch {
        return $false
    }
}

# é‡å¯MCPæœåŠ¡
function Restart-MCPService {
    param([string]$ServiceName)
    
    Write-Log "æ­£åœ¨é‡å¯ $ServiceName..."
    
    try {
        # åœæ­¢ç°æœ‰è¿›ç¨‹
        Stop-Process -Name $ServiceName -Force -ErrorAction SilentlyContinue
        Start-Sleep -Seconds 5
        
        # é‡å¯æœåŠ¡ï¼ˆéœ€è¦æ ¹æ®å®é™…å¯åŠ¨å‘½ä»¤è°ƒæ•´ï¼‰
        switch ($ServiceName) {
            "yingmi_mcp" {
                Start-Process -FilePath "python" -ArgumentList "-m", "yingmi_mcp" -WindowStyle Hidden
            }
            "caixin_mcp" {
                Start-Process -FilePath "python" -ArgumentList "-m", "caixin_mcp" -WindowStyle Hidden
            }
            "tavily_mcp" {
                Start-Process -FilePath "python" -ArgumentList "-m", "tavily_mcp" -WindowStyle Hidden
            }
        }
        
        Start-Sleep -Seconds 10
        Write-Log "$ServiceName é‡å¯å®Œæˆ"
        return $true
    }
    catch {
        Write-Log "é‡å¯ $ServiceName å¤±è´¥: $($_.Exception.Message)"
        return $false
    }
}

# ä¸»ç›‘æ§å¾ªç¯
Write-Log "MCPç›‘æ§æœåŠ¡å¯åŠ¨"

while ($true) {
    foreach ($service in $MCPProcesses) {
        if (-not (Test-MCPService -ServiceName $service)) {
            Write-Log "æ£€æµ‹åˆ° $service ç¦»çº¿ï¼Œå¼€å§‹é‡è¿..."
            
            $retryCount = 0
            $success = $false
            
            while ($retryCount -lt $MaxRetries -and -not $success) {
                $retryCount++
                Write-Log "ç¬¬ $retryCount æ¬¡å°è¯•é‡è¿ $service..."
                
                if (Restart-MCPService -ServiceName $service) {
                    Start-Sleep -Seconds 15
                    if (Test-MCPService -ServiceName $service) {
                        Write-Log "$service é‡è¿æˆåŠŸï¼"
                        $success = $true
                    }
                }
                
                if (-not $success -and $retryCount -lt $MaxRetries) {
                    Start-Sleep -Seconds 30
                }
            }
            
            if (-not $success) {
                Write-Log "$service é‡è¿å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
            }
        }
    }
    
    Start-Sleep -Seconds $CheckInterval
}
```

### æ–¹æ¡ˆä¸‰ï¼šæ‰¹å¤„ç†æ–‡ä»¶è‡ªåŠ¨é‡è¿

åˆ›å»ºç®€å•çš„æ‰¹å¤„ç†é‡è¿è„šæœ¬ï¼š

```batch
@echo off
REM ä¿å­˜ä¸º: MCP_AutoStart.bat

:LOOP
echo %date% %time% - æ£€æŸ¥MCPå·¥å…·çŠ¶æ€...

REM æ£€æŸ¥å¹¶é‡å¯yingmi MCP
tasklist | find "yingmi_mcp" >nul
if errorlevel 1 (
    echo %date% %time% - yingmi_mcpç¦»çº¿ï¼Œæ­£åœ¨é‡å¯...
    start /B python -m yingmi_mcp
    timeout /t 10
)

REM æ£€æŸ¥å¹¶é‡å¯caixin MCP
tasklist | find "caixin_mcp" >nul
if errorlevel 1 (
    echo %date% %time% - caixin_mcpç¦»çº¿ï¼Œæ­£åœ¨é‡å¯...
    start /B python -m caixin_mcp
    timeout /t 10
)

REM æ£€æŸ¥å¹¶é‡å¯Tavily MCP
tasklist | find "tavily_mcp" >nul
if errorlevel 1 (
    echo %date% %time% - tavily_mcpç¦»çº¿ï¼Œæ­£åœ¨é‡å¯...
    start /B python -m tavily_mcp
    timeout /t 10
)

echo %date% %time% - æ£€æŸ¥å®Œæˆï¼Œç­‰å¾…30ç§’...
timeout /t 30
goto LOOP
```

### æ–¹æ¡ˆå››ï¼šPythonç›‘æ§è„šæœ¬

åˆ›å»ºæ›´æ™ºèƒ½çš„Pythonç›‘æ§è„šæœ¬ï¼š

```python
# ä¿å­˜ä¸º: mcp_monitor.py
import time
import subprocess
import requests
import logging
from datetime import datetime
import psutil
import os

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('mcp_monitor.log'),
        logging.StreamHandler()
    ]
)

class MCPMonitor:
    def __init__(self):
        self.services = {
            'yingmi_mcp': {
                'process_name': 'yingmi_mcp',
                'start_command': ['python', '-m', 'yingmi_mcp'],
                'health_check_url': None,  # å¦‚æœæœ‰å¥åº·æ£€æŸ¥URL
                'max_retries': 3,
                'retry_delay': 30
            },
            'caixin_mcp': {
                'process_name': 'caixin_mcp', 
                'start_command': ['python', '-m', 'caixin_mcp'],
                'health_check_url': None,
                'max_retries': 3,
                'retry_delay': 30
            },
            'tavily_mcp': {
                'process_name': 'tavily_mcp',
                'start_command': ['python', '-m', 'tavily_mcp'], 
                'health_check_url': None,
                'max_retries': 3,
                'retry_delay': 30
            }
        }
        
    def is_process_running(self, process_name):
        """æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿è¡Œ"""
        for proc in psutil.process_iter(['pid', 'name']):
            try:
                if process_name.lower() in proc.info['name'].lower():
                    return True
            except (psutil.NoSuchProcess, psutil.AccessDenied):
                continue
        return False
        
    def health_check(self, service_name):
        """å¥åº·æ£€æŸ¥"""
        service = self.services[service_name]
        
        # é¦–å…ˆæ£€æŸ¥è¿›ç¨‹
        if not self.is_process_running(service['process_name']):
            return False
            
        # å¦‚æœæœ‰å¥åº·æ£€æŸ¥URLï¼Œè¿›è¡ŒHTTPæ£€æŸ¥
        if service.get('health_check_url'):
            try:
                response = requests.get(service['health_check_url'], timeout=10)
                return response.status_code == 200
            except:
                return False
                
        return True
        
    def start_service(self, service_name):
        """å¯åŠ¨æœåŠ¡"""
        service = self.services[service_name]
        
        try:
            # å…ˆæ€æ­»ç°æœ‰è¿›ç¨‹
            self.kill_service(service_name)
            time.sleep(5)
            
            # å¯åŠ¨æ–°è¿›ç¨‹
            subprocess.Popen(
                service['start_command'],
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL
            )
            
            logging.info(f"å·²å¯åŠ¨ {service_name}")
            return True
            
        except Exception as e:
            logging.error(f"å¯åŠ¨ {service_name} å¤±è´¥: {e}")
            return False
            
    def kill_service(self, service_name):
        """åœæ­¢æœåŠ¡"""
        service = self.services[service_name]
        process_name = service['process_name']
        
        for proc in psutil.process_iter(['pid', 'name']):
            try:
                if process_name.lower() in proc.info['name'].lower():
                    proc.terminate()
                    time.sleep(2)
                    if proc.is_running():
                        proc.kill()
            except (psutil.NoSuchProcess, psutil.AccessDenied):
                continue
                
    def monitor_service(self, service_name):
        """ç›‘æ§å•ä¸ªæœåŠ¡"""
        service = self.services[service_name]
        
        if not self.health_check(service_name):
            logging.warning(f"{service_name} ç¦»çº¿ï¼Œå¼€å§‹é‡è¿...")
            
            for attempt in range(service['max_retries']):
                logging.info(f"ç¬¬ {attempt + 1} æ¬¡å°è¯•é‡å¯ {service_name}")
                
                if self.start_service(service_name):
                    time.sleep(15)  # ç­‰å¾…æœåŠ¡å¯åŠ¨
                    
                    if self.health_check(service_name):
                        logging.info(f"{service_name} é‡è¿æˆåŠŸï¼")
                        return True
                        
                if attempt < service['max_retries'] - 1:
                    time.sleep(service['retry_delay'])
                    
            logging.error(f"{service_name} é‡è¿å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°")
            return False
            
        return True
        
    def run(self, check_interval=30):
        """è¿è¡Œç›‘æ§"""
        logging.info("MCPç›‘æ§æœåŠ¡å¯åŠ¨")
        
        while True:
            try:
                for service_name in self.services:
                    self.monitor_service(service_name)
                    
                time.sleep(check_interval)
                
            except KeyboardInterrupt:
                logging.info("ç›‘æ§æœåŠ¡åœæ­¢")
                break
            except Exception as e:
                logging.error(f"ç›‘æ§æœåŠ¡å¼‚å¸¸: {e}")
                time.sleep(60)

if __name__ == "__main__":
    monitor = MCPMonitor()
    monitor.run()
```

## ğŸ“‹ å®æ–½æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©æ–¹æ¡ˆ
- **ç®€å•éœ€æ±‚**ï¼šä½¿ç”¨æ‰¹å¤„ç†æ–‡ä»¶ï¼ˆæ–¹æ¡ˆä¸‰ï¼‰
- **é«˜çº§éœ€æ±‚**ï¼šä½¿ç”¨PowerShellè„šæœ¬ï¼ˆæ–¹æ¡ˆäºŒï¼‰
- **ä¸“ä¸šéœ€æ±‚**ï¼šä½¿ç”¨Pythonè„šæœ¬ï¼ˆæ–¹æ¡ˆå››ï¼‰

### ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²è„šæœ¬
1. é€‰æ‹©åˆé€‚çš„è„šæœ¬å¹¶ä¿å­˜åˆ°æ‚¨çš„å·¥ä½œç›®å½•
2. æ ¹æ®å®é™…MCPå·¥å…·çš„å¯åŠ¨æ–¹å¼è°ƒæ•´è„šæœ¬å‚æ•°
3. æµ‹è¯•è„šæœ¬æ˜¯å¦èƒ½æ­£ç¡®æ£€æµ‹å’Œé‡å¯MCPå·¥å…·

### ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®è‡ªåŠ¨å¯åŠ¨
- **Windowsä»»åŠ¡è®¡åˆ’ç¨‹åº**ï¼šè®¾ç½®å¼€æœºè‡ªåŠ¨è¿è¡Œç›‘æ§è„šæœ¬
- **ç³»ç»ŸæœåŠ¡**ï¼šå°†ç›‘æ§è„šæœ¬æ³¨å†Œä¸ºWindowsæœåŠ¡
- **å¿«æ·æ–¹å¼**ï¼šåˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼å¿«é€Ÿå¯åŠ¨

### ç¬¬å››æ­¥ï¼šä¼˜åŒ–ç½‘ç»œç¯å¢ƒ
```cmd
REM ä¼˜åŒ–ç½‘ç»œè®¾ç½®
netsh int tcp set global autotuninglevel=normal
netsh int tcp set global chimney=enabled
netsh int tcp set global rss=enabled
```

## âš™ï¸ é«˜çº§é…ç½®

### MCPå·¥å…·å¯åŠ¨å‚æ•°ä¼˜åŒ–
ä¸ºæ¯ä¸ªMCPå·¥å…·æ·»åŠ è¿æ¥ç¨³å®šæ€§å‚æ•°ï¼š

```bash
# yingmi MCPå¯åŠ¨å‚æ•°
python -m yingmi_mcp --timeout=60 --retry-count=5 --keep-alive=30

# caixin MCPå¯åŠ¨å‚æ•°  
python -m caixin_mcp --timeout=60 --retry-count=5 --keep-alive=30

# Tavily MCPå¯åŠ¨å‚æ•°
python -m tavily_mcp --timeout=60 --retry-count=5 --keep-alive=30
```

### ç¯å¢ƒå˜é‡ä¼˜åŒ–
è®¾ç½®ç¯å¢ƒå˜é‡æé«˜è¿æ¥ç¨³å®šæ€§ï¼š

```bash
SET MCP_CONNECTION_TIMEOUT=60
SET MCP_MAX_RETRIES=5
SET MCP_RETRY_DELAY=5
SET MCP_KEEP_ALIVE=30
```

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æ—¥å¿—åˆ†æ
ç›‘æ§è„šæœ¬ä¼šç”Ÿæˆè¯¦ç»†æ—¥å¿—ï¼Œé€šè¿‡æ—¥å¿—åˆ†æè¿æ¥é—®é¢˜ï¼š

```powershell
# æŸ¥çœ‹æœ€è¿‘çš„è¿æ¥é—®é¢˜
Get-Content MCP_Monitor.log | Select-String "ç¦»çº¿|å¤±è´¥|é”™è¯¯" | Select-Object -Last 20
```

### æ€§èƒ½ç›‘æ§
```powershell
# ç›‘æ§MCPå·¥å…·èµ„æºä½¿ç”¨
Get-Process | Where-Object {$_.ProcessName -like "*mcp*"} | Select-Object ProcessName, CPU, WorkingSet
```

## ğŸ“ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

1. **è„šæœ¬æ— æ³•æ£€æµ‹åˆ°MCPè¿›ç¨‹**
   - æ£€æŸ¥è¿›ç¨‹åç§°æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤MCPå·¥å…·æ˜¯å¦æ­£ç¡®å®‰è£…

2. **é‡å¯å¤±è´¥**
   - æ£€æŸ¥å¯åŠ¨å‘½ä»¤æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤Pythonç¯å¢ƒå’Œä¾èµ–åŒ…

3. **æƒé™é—®é¢˜**
   - ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œè„šæœ¬
   - æ£€æŸ¥æ–‡ä»¶å’Œæ–‡ä»¶å¤¹æƒé™

4. **ç½‘ç»œé—®é¢˜**
   - æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
   - ç¡®è®¤ä»£ç†é…ç½®

## ğŸš€ ä½¿ç”¨å»ºè®®

1. **é€‰æ‹©Pythonæ–¹æ¡ˆ**ï¼šåŠŸèƒ½æœ€å…¨é¢ï¼Œæ¨èä¸“ä¸šç”¨æˆ·ä½¿ç”¨
2. **è®¾ç½®åˆç†çš„æ£€æŸ¥é—´éš”**ï¼šå»ºè®®30-60ç§’
3. **é…ç½®å¼€æœºè‡ªå¯åŠ¨**ï¼šç¡®ä¿ç³»ç»Ÿé‡å¯åè‡ªåŠ¨è¿è¡Œ
4. **å®šæœŸæ£€æŸ¥æ—¥å¿—**ï¼šåŠæ—¶å‘ç°å’Œè§£å†³é—®é¢˜
5. **å¤‡ä»½é‡è¦é…ç½®**ï¼šé¿å…é…ç½®ä¸¢å¤±

---

## ğŸš¨ é‡è¦å…è´£å£°æ˜

**æœ¬æŠ€æœ¯æ–¹æ¡ˆä»…ä¾›å‚è€ƒï¼Œä¸ä¿è¯100%è§£å†³æ‰€æœ‰è¿æ¥é—®é¢˜**

### é£é™©æç¤º
- ğŸ“ˆ **ç³»ç»Ÿé£é™©**ï¼šè‡ªåŠ¨é‡è¿è„šæœ¬å¯èƒ½å½±å“ç³»ç»Ÿæ€§èƒ½
- ğŸ’° **ä½¿ç”¨é£é™©**ï¼šè¯·åœ¨æµ‹è¯•ç¯å¢ƒä¸­å……åˆ†éªŒè¯åå†éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- ğŸ“Š **å…¼å®¹é£é™©**ï¼šä¸åŒç‰ˆæœ¬çš„MCPå·¥å…·å¯èƒ½éœ€è¦è°ƒæ•´è„šæœ¬å‚æ•°
- âš–ï¸ **ç»´æŠ¤é£é™©**ï¼šéœ€è¦å®šæœŸç»´æŠ¤å’Œæ›´æ–°è„šæœ¬

### æŠ€æœ¯å£°æ˜
- ğŸ›ï¸ **éå®˜æ–¹æ–¹æ¡ˆ**ï¼šæœ¬æ–¹æ¡ˆä¸ºç¬¬ä¸‰æ–¹æŠ€æœ¯è§£å†³æ–¹æ¡ˆï¼Œéå®˜æ–¹æ”¯æŒ
- ğŸ“ **ä½¿ç”¨è´£ä»»**ï¼šç”¨æˆ·éœ€è‡ªè¡Œæ‰¿æ‹…ä½¿ç”¨è„šæœ¬çš„é£é™©å’Œè´£ä»»
- ğŸ” **æµ‹è¯•å»ºè®®**ï¼šå»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒä¸­å……åˆ†æµ‹è¯•åå†æ­£å¼ä½¿ç”¨
- â° **æ›´æ–°æé†’**ï¼šMCPå·¥å…·æ›´æ–°åå¯èƒ½éœ€è¦è°ƒæ•´è„šæœ¬å‚æ•°

**æŠ€æœ¯æœ‰é£é™©ï¼Œä½¿ç”¨éœ€è°¨æ…ã€‚æœ¬æ–¹æ¡ˆä¸å¯¹æŠ€æœ¯å®æ–½ç»“æœæ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚**

---


